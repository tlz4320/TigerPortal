##2.0之后
sg_anno1 <- data.frame(sg = c("Sg_10_69",
                              "Sg_22_153",
                              "Sg_21_143",
                              "Sg_15_101",
                              "Sg_19_131",
                              "Sg_13_89",
                              "Sg_3_16",
                              "Sg_4_24",
                              "Sg_18_126",
                              "Sg_11_74",
                              "Sg_16_109",
                              "Sg_13_88",
                              "Sg_6_42",
                              "Sg_7_49",
                              "Sg_24_182",
                              "Sg_24_181",
                              "Sg_24_186",
                              "Sg_24_185",
                              "Sg_24_190",
                              "Sg_24_189",
                              "Sg_24_234",
                              "Sg_24_233", 
                              "Sg_21_145",
                              "Sg_12_81",
                              "Sg_16_107",
                              "Sg_15_105",
                              "Sg_10_65",
                              "Sg_5_32",
                              "Sg_20_140",
                              "Sg_17_119",
                              "Sg_5_35",
                              "Sg_17_116",
                              "Sg_20_136",
                              "Sg_23_156",
                              "Sg_24_230",
                              "Sg_24_229",
                              "Sg_24_231",
                              "Sg_24_232", 
                              "Sg_24_183",
                              "Sg_24_184"), 
                       dis = 0)
sg_anno2 <- data.frame(sg = c("Sg_9_63",
                              "Sg_8_54",
                              "Sg_1_7",
                              "Sg_3_21",
                              "Sg_3_19",
                              "Sg_2_12",
                              "Sg_5_30",
                              "Sg_14_93",
                              "Sg_18_124",
                              "Sg_21_146",
                              "Sg_24_263",
                              "Sg_24_264",
                              "Sg_24_266",
                              "Sg_24_265",
                              "Sg_24_294",
                              "Sg_24_293",
                              "Sg_24_236",
                              "Sg_24_235",
                              "Sg_24_237",
                              "Sg_24_238",
                              "Sg_12_80",
                              "Sg_9_59",
                              "Sg_18_121",
                              "Sg_12_79",
                              "Sg_3_20",
                              "Sg_4_27",
                              "Sg_8_52",
                              "Sg_14_94",
                              "Sg_24_162",
                              "Sg_24_161",
                              "Sg_24_165",
                              "Sg_24_166",
                              "Sg_24_167",
                              "Sg_24_168",
                              "Sg_24_175",
                              "Sg_24_176", 
                              "Sg_24_204",
                              "Sg_24_203", 
                              "Sg_4_26",
                              "Sg_3_18", 
                              "Sg_19_127",
                              "Sg_6_36",
                              "Sg_24_261",
                              "Sg_24_262",
                              "Sg_24_288",
                              "Sg_24_287",
                              "Sg_20_135",
                              "Sg_23_155",
                              "Sg_24_310", 
                              "Sg_24_309"), 
                       dis = 1)

sg_anno3 <- data.frame(sg = c("Sg_11_77",
                              "Sg_8_56",
                              "Sg_24_276",
                              "Sg_24_275",
                              "Sg_1_2",
                              "Sg_2_10",
                              "Sg_14_98",
                              "Sg_23_160",
                              "Sg_14_96",
                              "Sg_20_137",
                              "Sg_24_197",
                              "Sg_24_198",
                              "Sg_24_187",
                              "Sg_24_188",
                              "Sg_24_195",
                              "Sg_24_196",
                              "Sg_24_199",
                              "Sg_24_200",
                              "Sg_6_41",
                              "Sg_7_48",
                              "Sg_24_164",
                              "Sg_24_163",
                              "Sg_24_217",
                              "Sg_24_218", 
                              "Sg_8_53",
                              "Sg_12_84"), 
                       dis = 1)


sg_anno4 <- data.frame(sg = c("Sg_3_15",
                              "Sg_1_1",
                              "Sg_10_70",
                              "Sg_14_95",
                              "Sg_24_246",
                              "Sg_24_245",
                              "Sg_24_247",
                              "Sg_24_248",
                              "Sg_24_251",
                              "Sg_24_252",
                              "Sg_24_254",
                              "Sg_24_253",
                              "Sg_24_277",
                              "Sg_24_278",
                              "Sg_24_260",
                              "Sg_24_259", 
                              "Sg_15_100",
                              "Sg_9_58",
                              
                              "Sg_10_67",
                              "Sg_19_129",
                              "Sg_10_64",
                              "Sg_18_120",
                              "Sg_1_5",
                              "Sg_2_11",
                              "Sg_24_202",
                              "Sg_24_201",
                              "Sg_24_205",
                              "Sg_24_206",
                              "Sg_24_308",
                              "Sg_24_307",
                              "Sg_24_211",
                              "Sg_24_212",
                              "Sg_24_213",
                              "Sg_24_214",
                              "Sg_24_215",
                              "Sg_24_216",
                              "Sg_24_219",
                              "Sg_24_220",
                              "Sg_16_110",
                              "Sg_7_47", 
                              "Sg_21_142",
                              "Sg_5_31",
                              "Sg_24_173",
                              "Sg_24_174",
                              "Sg_24_179",
                              "Sg_24_180", 
                              "Sg_24_271",
                              "Sg_24_272", 
                              "Sg_7_44",
                              "Sg_6_39", 
                              "Sg_13_86",
                              "Sg_9_61", 
                              "Sg_8_50","Sg_5_29", 
                              "Sg_21_147","Sg_12_82","Sg_23_158","Sg_20_138","Sg_5_33","Sg_10_66",
                              "Sg_24_304","Sg_24_303"),
                       dis = 2)

sg_anno5 <- data.frame(sg = c("Sg_16_108",
                              "Sg_11_75",
                              "Sg_21_141",
                              "Sg_11_72",
                              "Sg_11_76",
                              "Sg_23_157",
                              "Sg_24_273",
                              "Sg_24_274"), 
                       dis = 3)

sg_anno6 <- data.frame(sg = c("Sg_20_139","Sg_17_118", 
                              "Sg_22_151","Sg_19_130","Sg_17_114","Sg_8_51",
                              "Sg_24_301","Sg_24_302","Sg_24_305","Sg_24_306",
                              "Sg_24_316","Sg_24_315","Sg_24_320","Sg_24_319",
                              
                              "Sg_24_314",
                              "Sg_24_313", "Sg_16_106","Sg_17_113","Sg_18_125",
                              "Sg_15_104","Sg_24_296","Sg_24_295","Sg_24_317","Sg_24_318"),
                       dis = 3)

sg_anno7 <- c(                              "Sg_1_6",
                                            "Sg_2_14",
                                            "Sg_3_17",
                                            "Sg_1_3",
                                            "Sg_19_132",
                                            "Sg_13_90",
                                            "Sg_15_99",
                                            "Sg_20_134",
                                            "Sg_24_227",
                                            "Sg_24_228",
                                            "Sg_24_242",
                                            "Sg_24_241",
                                            "Sg_24_243",
                                            "Sg_24_244",
                                            "Sg_19_128",
                                            "Sg_22_149")


sg_dis_anno <- data.frame(do.call(rbind, list(sg_anno1, sg_anno2,
                                              sg_anno3, sg_anno4,
                                              sg_anno5, sg_anno6)))



calDiff <- function(ref, pos, ins_ref, ins_target){
  mut <- ref[- (20 + 4 - pos)]
  pos <- 20
  ins_ref$diff <- 0
  for(i in 1 : nrow(ins_ref)){
    tmp <- c(mut[1 : (pos - 1)], ins_ref$NT[i], mut[pos : length(mut)])
    ins_ref$diff[i] <- sum(tmp != ref)
  }
  ins_target$diff <- 0
  for(i in 1 : nrow(ins_target)){
    tmp <- c(mut[1 : (pos - 1)], ins_target$NT[i], mut[pos : length(mut)])
    ins_target$diff[i] <- sum(tmp != ref)
  }
  return(list(ref = ins_ref, target = ins_target))
}
calDiff2 <- function(ref, pos){
  mut <- ref[- (20 + 4 - pos)]
  pos <- 20
  ins_ref <- list()
  for(i in c("A", "T", "C", "G")){
    tmp <- c(mut[1 : (pos - 1)], i, mut[pos : length(mut)])
    ins_ref[[i]] <- sum(tmp != ref)
  }
  return(ins_ref)
}

ins1_lr_nt_stat <- openxlsx::read.xlsx("~/Nutstore Files/Tobin/Merged1NT/merged_ins1_left_right_nt_pie_data.xlsx")
###在2.0脚本之后运行
sgCmp$pos[sgCmp$pos == 20] <- 1
sample_info <- data.frame(sg = bulge_pos_order)
sample_info$id <- unlist(lapply(sample_info$sg, function(x){
  sgCmp$id[sgCmp$id2 == x]
}))
total_plot_data <- list()
for(id in unique(sample_info$id)){
  sgs <- sample_info$sg[sample_info$id == id]
  ins_one_seq <- wt_seqs[[sgs[1]]]
  del_one_seq <- wt_seqs[[sgs[2]]]
  bulgepos <- bulge_pos$V5[bulge_pos$V4 == id]
  ins_one_left <- ins_one_seq[20]
  del_one_left <- del_one_seq[20]
  ins_one_right <- ins_one_seq[21]
  del_one_right <- del_one_seq[21]
  
  ins_one_stat <- remain_ins1_pct_table[[sgs[1]]]
  del_one_stat <- remain_ins1_pct_table[[sgs[2]]]
  
  ifremain1 <- sum(ins_one_stat$Pct[ins_one_stat$pos %in% c(20, 21)]) / sum(ins_one_stat$Pct) * 100
  ifremain2 <- sum(del_one_stat$Pct[del_one_stat$pos %in% c(20, 21)]) / sum(del_one_stat$Pct) * 100
  if(ifremain1 < 1 | ifremain2 < 1){
    next
  }
  
  
  ins_one_stat <- ins_one_stat[ins_one_stat$pos %in% c(20, 21),]
  del_one_stat <- del_one_stat[del_one_stat$pos %in% c(20, 21),]
  ins_one_diff <- sum(ins_one_stat$Pct[ins_one_stat$NT == ins_one_left]) / sum(ins_one_stat$Pct)
  del_one_diff <- sum(del_one_stat$Pct[del_one_stat$NT == del_one_left]) / sum(del_one_stat$Pct)
  # tmp_res <- calDiff(ins_one_seq, as.numeric(bulgepos), ins_one_stat,del_one_stat)
  # ins_one_diff <- tmp_res$ref
  # if(ins_one_left != del_one_left){
  #   tmp <- ins1_lr_nt_stat[ins1_lr_nt_stat$leftNT == del_one_left & 
  #                            ins1_lr_nt_stat$rightNT == ins_one_right,c(-1,-2)]
  #   tmp_diff <- unlist(calDiff2(ins_one_seq, as.numeric(bulgepos)))
  #   tmp_diff <- tmp_diff[colnames(tmp)]
  #   tmp <- unlist(tmp)
  #   ins_one_diff <- sum(tmp / sum(tmp) * tmp_diff)
  # } else{
  #   ins_one_diff <- sum(ins_one_diff$Pct / 
  #                         sum(ins_one_diff$Pct) * ins_one_diff$diff)
  # }
  # 
  # del_one_diff <- tmp_res$target
  # del_one_diff <- sum(del_one_diff$Pct / 
  #                       sum(del_one_diff$Pct) * del_one_diff$diff)
  total_plot_data[[id]] <- data.frame(diff = c(ins_one_diff, del_one_diff), type=c("Ref", "Target"),
                                      sg = sgs, NT = ins_one_left, id = id, sameRight = (ins_one_right == del_one_right), 
                                      sameLeft = (ins_one_left == del_one_left), 
                                      sameLR = c(ins_one_left == ins_one_right, del_one_left == del_one_right))
}
total_plot_data <- data.frame(do.call(rbind, total_plot_data))
total_plot_data$type <- factor(total_plot_data$type, levels = c("Ref", "Target"))
total_plot_data$ltp <- ifelse(total_plot_data$sameRight, "SameRight", "DiffRight")
total_plot_data$ltp <- factor(total_plot_data$ltp, levels = c("SameRight", "DiffRight"))
total_plot_data2 <- merge(total_plot_data, sg_dis_anno, by="sg")
total_plot_data2 <- total_plot_data2[order(total_plot_data2$dis, total_plot_data2$id),]
total_plot_data2$shape <- ifelse(total_plot_data2$type == "Target", 25, 24)
total_plot_data2$color <- "black"
total_plot_data2$color[!total_plot_data2$sameLeft] <- "purple"


###后面是读取预测的结果
setwd('~/indelphi_res_HEK293/')
indelphi_132_res <- list()
for(file in list.files()){
  indelphi_132_res[[file]] <- read.table(file,sep = ",", header = T)
}
names(indelphi_132_res) <- str_remove(names(indelphi_132_res), ".csv")
indelphi_res_ins1 <- lapply(indelphi_132_res, function(x){
  x <- x[x$Category == "ins" & x$Length == 1,]
  x$Pct <- x$Predicted.frequency / sum(x$Predicted.frequency) * 100
  colnames(x)[4] <- "NT"
  x
})

setwd('~/forecast132_result/')
forcast_file <- read.table("~/132_for_forecast.txt")
forecast_132_res_ins1 <- list()
for(file in forcast_file$V1){
  tmp1 <- read.table(paste0(file, "_predictedindelsummary.txt"), 
                     sep = "\t", header = T)
  colnames(tmp1) <- c("V1", "NT", "Count")
  tmp2 <- read.table(paste0(file, "_predictedreads.txt"), 
                     sep = "\t", header = F)
  sg <- sgCmp$sgRNA[sgCmp$id2 == file]
  cutpos <- unlist(str_locate(tmp2[1,2], sg)[1]) + 17
  tmp2 <- merge(tmp2, tmp1, by.y='V1', by.x = "V3")
  type <- unlist(lapply(tmp2[,1], function(x){
    unlist(strsplit(x, "[_]"))[1]
  }))
  tmp2 <- tmp2[type == "I1",]
  tmp2$NT <- unlist(lapply(tmp2$V2, function(x){
    str_sub(x, cutpos, cutpos)
  }))
  forecast_132_res_ins1[[file]] <- tmp2
}



calDiff_forpd <- function(ref, pos, ins1){
  mut <- ref[- (20 + 4 - pos)]
  pos <- 20
  ins1$diff <- 0
  for(i in 1 : nrow(ins1)){
    tmp <- c(mut[1 : (pos - 1)], ins1$NT[i], mut[pos : length(mut)])
    ins1$diff[i] <- sum(tmp != ref)
  }
  ins1
}

total_plot_data3 <- total_plot_data2
predict_data <- list()
for(id in unique(total_plot_data3$id)){
  sgs <- sample_info$sg[sample_info$id == id]
  ins_one_seq <- wt_seqs[[sgs[1]]]
  del_one_seq <- wt_seqs[[sgs[2]]]
  bulgepos <- bulge_pos$V5[bulge_pos$V4 == id]
  ins_one_left <- ins_one_seq[20]
  del_one_left <- del_one_seq[20]
  ins_one_right <- ins_one_seq[21]
  del_one_right <- del_one_seq[21]
  
  ins_one_stat <- remain_ins1_pct_table[[sgs[1]]]
  del_one_stat <- remain_ins1_pct_table[[sgs[2]]]
  
  
  # tmp_ins1 <- forecast_132_res_ins1[[sgs[2]]]
  # tmp_res <- calDiff_forpd(ins_one_seq, as.numeric(bulgepos), tmp_ins1)
  # forecast_diff <- sum(tmp_res$Count / sum(tmp_res$Count) * tmp_res$diff)
  # tmp_ins1 <- indelphi_res_ins1[[sgs[2]]]
  # tmp_res <- calDiff_forpd(ins_one_seq, as.numeric(bulgepos), tmp_ins1)
  # indelphi_diff <- sum(tmp_res$Pct / sum(tmp_res$Pct) * tmp_res$diff)
  tmp_del1 <- forecast_132_res_ins1[[sgs[2]]]
  forecast_diff <- sum(tmp_del1$Count[tmp_del1$NT == del_one_left]) / sum(tmp_del1$Count)
  tmp_del1 <- indelphi_res_ins1[[sgs[2]]]
  indelphi_diff <- sum(tmp_del1$Pct[tmp_del1$NT == del_one_left]) / sum(tmp_del1$Pct)
  tmp_res <- total_plot_data2[total_plot_data2$id == id,]
  tmp_res$shape <- tmp_res$shape[tmp_res$sg == sgs[2]]
  tmp_res$sg <- sgs[2]
  tmp_res$diff <- c(forecast_diff, indelphi_diff)
  tmp_res$type <- c("FORECasT", "inDelphi")
  
  predict_data[[id]] <- tmp_res
}
predict_data <- data.frame(do.call(rbind, predict_data))
predict_data <- predict_data[predict_data$sg %in% total_plot_data3$sg,]
total_plot_data3 <- data.frame(rbind(predict_data, total_plot_data3))
total_plot_data3$type <- factor(total_plot_data3$type, levels = c( "Target","Ref", "FORECasT", "inDelphi"))

pdf("~/Nutstore Files/Tobin/Merged1NT/ins1_link_plot_add_predict.pdf", width = 8, height = 6)
ggplot(total_plot_data3, aes(x = type, y = diff, color = NT, fill = NT, group = id)) +
  geom_line(aes(x = type, y = diff, linetype = ltp)) + 
  geom_point(size = 2, 
             shape = total_plot_data3$shape, 
             color ="black") + xlab("") + ylab("Normalized(%)") +
  facet_wrap(~dis, nrow = 1) +
  scale_fill_manual(values = c("A" = "#2F89FC",
                               "T" = "#30E3CA",
                               "C" = "#66CD00",
                               "G" = "#98ABEF")) + 
  scale_color_manual(values = c("A" = "#2F89FC",
                                "T" = "#30E3CA",
                                "C" = "#66CD00",
                                "G" = "#98ABEF")) + 
  scale_y_reverse() + 
  theme_classic2() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
dev.off()

total_plot_data4 <- total_plot_data3

tmp <- total_plot_data4
tmp$type <- as.numeric(tmp$type)
tmp <- beeswarm::beeswarm(diff ~ type, tmp, corral = "none", corralWidth = 0.2, spacing = 0.4)
total_plot_data4$beex <- 0
for(i in 1 : 4){
  total_plot_data4[as.numeric(total_plot_data4$type) == i, "beex"] <- tmp$x[tmp$x.orig == i]
}


pdf("~/Nutstore Files/Tobin/Merged1NT/ins1_link_plot_add_predict_U2OS.pdf", width = 6, height = 4)
ggplot(total_plot_data4, aes(x = type, y = diff)) + 
  geom_violin(aes(fill = type), 
              alpha = 0.5, 
              scale = "width", 
              adjust = 1, 
              trim = TRUE) + 
  ggnewscale::new_scale("fill") +
  geom_point(aes(x = beex, fill=NT),
             size = 2, 
             shape = total_plot_data3$shape,
             color = "black") + 
  geom_line(aes(x = beex, y = diff, color = NT, 
                linetype = ltp, group = id), 
            linewidth=0.1) + 
  stat_compare_means(comparisons = list(c("Ref", "Target"), 
                                        c("Target", "FORECasT"),
                                        c("Target", "inDelphi")
                                        ), paired = T) +
  scale_x_discrete(labels = c("Target", "Ref", "FORECasT", "inDelPhi-U2OS")) + 
  xlab("") + ylab("Normalized Insert Left NT(%)") +
  theme_bw()
dev.off()
total_plot_data5 <- total_plot_data4[total_plot_data4$type != "inDelphi",]
total_plot_data5$type <- factor(as.character(total_plot_data5$type), 
                                levels = c("Target", "Ref", "FORECasT"))
pdf("~/Nutstore Files/Tobin/Merged1NT/ins1_link_plot_add_predict_U2OS_rm.pdf", width = 5, height = 4)
ggplot(total_plot_data5, aes(x = type, y = diff)) + 
  geom_violin(aes(fill = type), 
              alpha = 0.5, 
              scale = "width", 
              adjust = 1, 
              trim = TRUE) + 
  ggnewscale::new_scale("fill") +
  geom_point(aes(x = beex, fill=NT),
             size = 2, 
             shape = total_plot_data5$shape,
             color = "black") + 
  geom_line(aes(x = beex, y = diff, color = NT, 
                linetype = ltp, group = id), 
            linewidth=0.1) + 
  stat_compare_means(comparisons = list(c("Ref", "Target"), 
                                        c("Target", "FORECasT")
  ), paired = T) +
  scale_x_discrete(labels = c("Target", "Ref", "FORECasT")) + 
  xlab("") + ylab("Normalized Insert Left NT(%)") +
  theme_bw()
dev.off()
